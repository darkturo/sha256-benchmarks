#!/bin/bash
#
# Depends: hyperfine
#

BASE_DIR=$(git rev-parse --show-toplevel)

RESULT_PREFIX="benchmark"
WARMUP=5
RUNS=1000
INPUT=abc
CONFIG=""
NAME=""
MACHINE=""
COMMAND=""

usage() {
	echo "Usage: $0 [OPTIONS] {-c <config>|<command>}"
	echo "Options:"
	echo "  -w <warmup>  Number of warmup runs default 5"
	echo "  -r <runs>    Number of runs default 1000"
	echo "  -m <machine> Machine name default `hostname`"
	echo "  -n <name>    Name of the benchmark (derived from command if not provided)"
	echo "  -c <config>  Configuration file or a directory with a benchmark.cfg file"
        echo "               with information about the command to benchmark."
	echo "Examples:"
	echo "  $0 -c openssl/config"
	echo "  $0 -n 'openssl-custom' -i abc -- openssl dgst -sha256"
}

get_field_from_config() {
	FIELD=$1
	CONFIG=$2
	RES=$(grep -E "^$FIELD=" $CONFIG | cut -d "=" -f 2)
	if [ -z "$RES" ]; then
		RES="undefined"
	fi
	echo $RES
}

run_shell() {
	WARMUP=$1
	RUNS=$2
	NAME=$3
	INPUT=$4
	RESULT_PATH=$5
	COMMAND=$6

	BENCHMARK="hyperfine -w $WARMUP -r $RUNS -n $NAME --export-json $RESULT_PATH"
	echo "Running: $BENCHMARK '$COMMAND'"
	$BENCHMARK -S 'bash --norc' -- "$COMMAND < $INPUT"
	echo "Benchmark results saved to $RESULT_PATH"
}

run_python() {
	WARMUP=$1
	RUNS=$2
	NAME=$3
	SETUP=$4
	INPUT=$5
	RESULT_PATH=$6
	COMMAND=$7

	PERF_OUT=pyperf-$NAME.json
	BENCHMARK="""python -m pyperf timeit -s '$SETUP' 'digest("`cat $INPUT`")' -o $PERF_OUT"""
	echo "Running: $BENCHMARK '$COMMAND'"
	$BENCHMARK -S 'bash --norc' -- "$COMMAND < $INPUT"
	echo "Benchmark results saved to $RESULT_PATH"
}

run_bin() {
	WARMUP=$1
	RUNS=$2
	NAME=$3
	INPUT=$4
	RESULT_PATH=$5
	COMMAND=$6

	BENCHMARK="$COMMAND --warmup $WARMUP --iterations $RUNS --input $INPUT --output $RESULT_PATH"
	echo "Running: $BENCHMARK"
	$BENCHMARK
	echo "Benchmark results saved to $RESULT_PATH"
}

benchmarker() {
	echo "********************************************************"
	RESULT_DIR=results
	if [ -n "$BASE_DIR" ]; then
		RESULT_DIR=$BASE_DIR/$RESULT_DIR
	fi

	echo "CMD: $0 $@"
	while getopts "c:w:r:i:n:m:h" opt; do
		case $opt in
			c) CONFIG=$OPTARG
				;;
			w) WARMUP=$OPTARG
				;;
			r) RUNS=$OPTARG
				;;
			i) INPUT=$OPTARG
				;;
			n) NAME=$OPTARG
				;;
			m) MACHINE=$OPTARG
				;;
			h)
				usage
				exit 0
				;;
			*) 
				echo "Invalid option -$OPTARG" >&2
				usage
				exit 1
				;;
		esac
	done

	if [ -n "$CONFIG" ]; then
		if [ -d "$CONFIG" ]; then
			CONFIG=$CONFIG/benchmark.cfg
		fi
		COMMAND=""
		. $CONFIG
	else
		if [ -z "$COMMAND" ]; then
			shift $((OPTIND -1))
			COMMAND=$@
		fi
	fi
	if [ -z "$MACHINE" ]; then
		MACHINE=$(hostname)
	fi
	if [ -z "$COMMAND" ]; then
		echo "Error: Please provide the command to run"
		exit 1
	fi
	if [ -z "$NAME" ]; then
		NAME=$(echo $COMMAND | cut -d " " -f 1)
	fi
	if [ -z "$INPUT" ]; then
		INPUT=abc
	fi
	INPUT=$BASE_DIR/inputs/${INPUT}.in

	TYPE=`get_field_from_config TYPE $CONFIG`

	DATE=$(date +'%Y%m%d')
	RESULT_PATH=$RESULT_DIR/${RESULT_PREFIX}-${NAME}-${TYPE}@${MACHINE}_${DATE}.json

	case $TYPE in 
		shell)
			run_shell $WARMUP $RUNS $NAME $INPUT $RESULT_PATH $COMMAND
			;;
		python)
			SETUP=`get_field_from_config SETUP $CONFIG`
			run_python $WARMUP $RUNS $NAME $SETUP $INPUT $RESULT_PATH $COMMAND
			;;
		bin)
			run_bin $WARMUP $RUNS $NAME $INPUT $RESULT_PATH $COMMAND
			;;
		*)
			echo "Error: Unsupported benchmark type $TYPE"
			exit 1
			;;
	esac
}

if [ "$0" = "$BASH_SOURCE" ]; then
	benchmarker "$@"
fi
